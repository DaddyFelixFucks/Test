--// DaddyFelix Triggerbot – Fixed & Clean \\--

local Game = cloneref(game)
if not Game:IsLoaded() then Game.Loaded:Wait() end

local Workspace = Game:GetService("Workspace")
local RunService = Game:GetService("RunService")
local Players = Game:GetService("Players")

local Config = getgenv().DaddyFelix
if not Config then error("DaddyFelix config missing!") end

local LocalPlayer = Players.LocalPlayer
local LocalCharacter = LocalPlayer.Character or LocalPlayer.CharacterAdded:Wait()
local LocalHumanoid = LocalCharacter:WaitForChild("Humanoid")
local LocalRootPart = LocalCharacter:WaitForChild("HumanoidRootPart")
local LocalGui = LocalPlayer:WaitForChild("PlayerGui")
local Camera = Workspace.CurrentCamera

local LastActivation = tick()
local ChatConn

-- Toggle with keyword
local function HookChat()
    if ChatConn then ChatConn:Disconnect() end
    ChatConn = LocalPlayer.Chatted:Connect(function(msg)
        if msg:lower() == Config.Triggerbot.Keyword:lower() then
            Config.Triggerbot.Enabled = not Config.Triggerbot.Enabled
            print("[DaddyFelix] Triggerbot " .. (Config.Triggerbot.Enabled and "ON" or "OFF"))
        end
    end)
end
HookChat()

LocalPlayer.CharacterAdded:Connect(function(char)
    LocalCharacter = char
    LocalHumanoid = char:WaitForChild("Humanoid")
    LocalRootPart = char:WaitForChild "HumanoidRootPart"
    HookChat()
end)

-- Circle
local Circle = Drawing.new("Circle")
Circle.Visible = false
Circle.Transparency = 1
Circle.Color = Color3.fromRGB(255,255,255)
Circle.Filled = true
Circle.Radius = 100
Circle.NumSides = 100
Circle.Position = Vector2.new(Camera.ViewportSize.X/2, Camera.ViewportSize.Y/2)

-- Wall Check
local function WallCheck(Part)
    if not Config.Checks.WallCheck then return false end
    local camPos = Camera.CFrame.Position
    local dir = (Part.Position - camPos)
    local params = RaycastParams.new()
    params.FilterDescendantsInstances = {LocalCharacter}
    params.FilterType = Enum.RaycastFilterType.Blacklist
    params.IgnoreWater = true
    local result = Workspace:Raycast(camPos, dir, params)
    return not result or result.Instance:IsDescendantOf(Part.Parent)
end

-- Forcefield Check
local function ForcefieldCheck(Char)
    if not Config.Checks.ForcefieldCheck then return false end
    return Char:FindFirstChildOfClass("ForceField")
end

-- KO Check
local function KOCheck(Char)
    if not Config.Checks.KOCheck then return false end
    local hum = Char:FindFirstChildOfClass("Humanoid")
    if not hum or hum.Health <= 0 then return true end
    local state = hum:GetState()
    if state == Enum.HumanoidStateType.Ragdoll or state == Enum.HumanoidStateType.Dead or state == Enum.HumanoidStateType.FallingDown then
        return true
    end
    local creator = Char:FindFirstChild("creator")
    if creator and creator:FindFirstChild("tag") then return true end
    return false
end

-- Blacklist Tool
local function IsBlacklisted(Tool)
    if not Tool then return false end
    local name = Tool.Name:lower()
    for word in pairs(Config.Tools.Blacklist) do
        if name:find(word) then return true end
    end
    return false
end

-- Prediction
local function Predict(Part, Root)
    local vel = Root and Root.Velocity or Vector3.zero
    return Part.Position + (vel * Config.Triggerbot.Prediction)
end

-- Cursor
local function GetCursor()
    local gui = LocalGui:FindFirstChild("MainScreenGui") or LocalGui:FindFirstChild("ScreenGui") or LocalGui:FindFirstChild("CoreGui")
    if not gui then return nil end
    return gui:FindFirstChild("Aim") or gui:FindFirstChild("AimUI") or gui:FindFirstChild("Crosshair")
end

-- Target
local function GetTarget()
    local best = math.huge
    local target = nil
    for _, pl in Players:GetPlayers() do
        if pl == LocalPlayer or not pl.Character then continue end
        local char = pl.Character
        if KOCheck(char) or ForcefieldCheck(char) then continue end
        local root = char:FindFirstChild("HumanoidRootPart")
        if not root then continue end
        for _, part in char:GetChildren() do
            if (part:IsA("BasePart") or part:IsA("MeshPart")) and part.Transparency < 1 then
                local pred = Predict(part, root)
                local scr, onScreen = Camera:WorldToViewportPoint(pred)
                if onScreen then
                    local dist = (Vector2.new(scr.X, scr.Y) - Circle.Position).Magnitude
                    if WallCheck(part) and dist < Circle.Radius and dist < best then
                        best = dist
                        target = pl
                    end
                end
            end
        end
    end
    return target
end

-- Main Loop
RunService.Heartbeat:Connect(function()
    if not Config.Triggerbot.Enabled then return end

    local cursor = GetCursor()
    if cursor then
        Circle.Position = cursor.AbsolutePosition
        Circle.Radius = math.max(cursor.AbsoluteSize.X, cursor.AbsoluteSize.Y) * 2.5
    end

    local target = GetTarget()
    if target and (tick() - LastActivation) >= Config.Triggerbot.Delay then
        local tool = LocalCharacter:FindFirstChildOfClass("Tool")
        if tool and tool:FindFirstChild("Handle") and not IsBlacklisted(tool) then
            tool:Activate()
            task.wait(0.1)
            tool:Deactivate()
            LastActivation = tick()
        end
    end
end)

print("[DaddyFelix] Loaded – type '"..Config.Triggerbot.Keyword.."' to toggle.")
