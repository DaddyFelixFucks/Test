local g = cloneref(game)
if not g:IsLoaded() then g.Loaded:Wait() end

local w = g:GetService("Workspace")
local rs = g:GetService("RunService")
local ps = g:GetService("Players")

local cfg = getgenv().DaddyFelix
if not cfg then error("no cfg") end

local lp = ps.LocalPlayer
local lc = lp.Character or lp.CharacterAdded:Wait()
local lh = lc:WaitForChild("Humanoid")
local lrp = lc:WaitForChild("HumanoidRootPart")
local lg = lp:WaitForChild("PlayerGui")
local cam = w.CurrentCamera

local lt = tick()
local cc

local function hc()
    if cc then cc:Disconnect() end
    cc = lp.Chatted:Connect(function(m)
        if m:lower() == cfg.Triggerbot.Keyword:lower() then
            cfg.Triggerbot.Enabled = not cfg.Triggerbot.Enabled
            print("[DF] " .. (cfg.Triggerbot.Enabled and "ON" or "OFF"))
        end
    end)
end
hc()

lp.CharacterAdded:Connect(function(c)
    lc = c
    lh = c:WaitForChild("Humanoid")
    lrp = c:WaitForChild("HumanoidRootPart")
    hc()
end)

local circ = Drawing.new("Circle")
circ.Transparency = 1
circ.Color = Color3.new(1, 1, 1)
circ.Filled = true
circ.Radius = 100
circ.NumSides = 100
circ.Position = cam.ViewportSize / 2

local function wall(p)
    if not cfg.Checks.WallCheck then return false end
    local cp = cam.CFrame.Position
    local dr = p.Position - cp
    local ryp = RaycastParams.new()
    ryp.FilterDescendantsInstances = {lc}
    ryp.FilterType = Enum.RaycastFilterType.Blacklist
    ryp.IgnoreWater = true
    local res = w:Raycast(cp, dr, ryp)
    return not res or res.Instance:IsDescendantOf(p.Parent)
end

local function ff(ch)
    if not cfg.Checks.ForcefieldCheck then return false end
    return ch:FindFirstChildOfClass("ForceField")
end

local function ko(ch)
    if not cfg.Checks.KOCheck then return false end
    local h = ch:FindFirstChildOfClass("Humanoid")
    if not h or h.Health <= 0 then return true end
    local s = h:GetState()
    if s == Enum.HumanoidStateType.Ragdoll or
       s == Enum.HumanoidStateType.Dead or
       s == Enum.HumanoidStateType.FallingDown then
        return true
    end
    local crt = ch:FindFirstChild("creator")
    if crt and crt:FindFirstChild("tag") then return true end
    return false
end

local function bl(t)
    if not t then return false end
    local n = t.Name:lower()
    for k in pairs(cfg.Tools.Blacklist) do
        if n:find(k) then return true end
    end
    return false
end

local function prd(pt, rt)
    local v = rt and rt.Velocity or Vector3.zero
    return pt.Position + (v * cfg.Triggerbot.Prediction)
end

local function crs()
    local g = lg:FindFirstChild("MainScreenGui") or
              lg:FindFirstChild("ScreenGui") or
              lg:FindFirstChild("CoreGui")
    if not g then return end
    return g:FindFirstChild("Aim") or
           g:FindFirstChild("AimUI") or
           g:FindFirstChild("Crosshair")
end

local function tar()
    local md = math.huge
    local mt = nil
    for _, pl in ps:GetPlayers() do
        if pl ~= lp and pl.Character then
            local ch = pl.Character
            if ko(ch) or ff(ch) then continue end
            local rt = ch:FindFirstChild("HumanoidRootPart")
            if not rt then continue end
            for _, pr in ch:GetChildren() do
                if (pr:IsA("BasePart") or pr:IsA("MeshPart")) and pr.Transparency < 1 then
                    local pp = prd(pr, rt)
                    local sc, on = cam:WorldToViewportPoint(pp)
                    if on then
                        local dst = (Vector2.new(sc.X, sc.Y) - circ.Position).Magnitude
                        if wall(pr) and dst < circ.Radius and dst < md then
                            md = dst
                            mt = pl
                        end
                    end
                end
            end
        end
    end
    return mt
end

rs.Heartbeat:Connect(function()
    if not cfg.Triggerbot.Enabled then return end
    local cu = crs()
    if cu then
        circ.Position = cu.AbsolutePosition
        circ.Radius = math.max(cu.AbsoluteSize.X, cu.AbsoluteSize.Y) * 1.5
    end
    local t = tar()
    if t and (tick() - lt) >= cfg.Triggerbot.Delay then
        local tl = lc:FindFirstChildOfClass("Tool")
        if tl and tl:FindFirstChild("Handle") and not bl(tl) then
            tl:Activate()
            task.wait(0.05)
            tl:Deactivate()
            lt = tick()
        end
    end
end)

print("[DF] goated")
